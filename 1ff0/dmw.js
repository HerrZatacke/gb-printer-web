(window.webpackJsonp=window.webpackJsonp||[]).push([[1],{263:function(t,e,n){"use strict";n(55),n(94);e.a=function(t){return t.replace(/[^a-z0-9/\\._-]/gi,"").replace(/[\\/]+/gi,"/").replace(/^\//,"").replace(/\/$/,"")}},265:function(t,e,n){"use strict";n(65),n(133),n(134),n(165),n(215),n(53),n(181),n(135),n(136),n(25),n(171),n(68),n(131),n(182),n(67),n(89),n(14),n(26),n(55),n(132),n(66),n(175),n(173),n(37);var r=n(212),o=n(202);function i(t){return function(t){if(Array.isArray(t))return a(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return a(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return a(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}e.a=function(t){var e=t.images,n=t.frames,a=e.length,c=n.length;return Promise.all([].concat(i(e.map((function(t,e){return Object(r.b)(t.hash,null,!0).then((function(n){return n.length?t.hash:t.getFileContent(t.sha,e,a).then((function(t){var e=t.split("\n").filter((function(t){return t.match(/^[0-9a-f ]+$/gi)}));return Object(r.c)(e)}))}))}))),i(n.map((function(t,e){return Object(o.a)(t.id).then((function(n){return n?t.id:t.getFileContent(t.sha,e,c).then((function(e){var n=JSON.parse(e,null,2),r=Array(32).fill("f").join(""),a=Array(16).fill(r),c=[].concat(i(n.upper),i(Array(14).fill().map((function(t,e){return[].concat(i(n.left[e]),i(a),i(n.right[e]))})).flat()),i(n.lower));return Object(o.b)(t.id,c)}))}))})))))}},291:function(t,e,n){"use strict";n(65),n(133),n(134),n(165),n(53),n(141),n(38),n(135),n(136),n(25),n(68),n(131),n(67),n(89),n(92),n(90),n(91),n(93),n(54),n(14),n(26),n(55),n(132),n(66),n(175),n(39),n(37);var r=n(232),o=n(192),i=n(203),a=n(202);n(196);function c(t){return function(t){if(Array.isArray(t))return u(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return u(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return u(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var s=function(t,e,n,r){var o=t.images,i=t.frames;return{upload:e.filter((function(t){var e=t.destination;return!o.find((function(t){return t.path===e}))&&!i.find((function(t){return t.path===e}))})),del:[].concat(c(c(o).filter((function(t){var o=t.path;return!n.find((function(t){var e=t.destination;return o===e}))&&!e.find((function(t){var e=t.destination;return o===e}))&&!r.find((function(t){return o.indexOf(t)>=-1}))}))),c(c(i).filter((function(t){var r=t.path;return!n.find((function(t){var e=t.destination;return r===e}))&&!e.find((function(t){var e=t.destination;return r===e}))}))))}},l=(n(171),n(173),n(290));function f(t){return function(t){if(Array.isArray(t))return h(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return h(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return h(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var p=function(t){var e=Object(l.a)(t);return function(t){var n=[],r=[],o={};t.forEach((function(t){var e=t.hash,i=t.files,a=t.inRepo;r.push.apply(r,f(a.map((function(t){var e=t.path,n=e.split("/")[0];return o[n]=o[n]?o[n]+1:1,{destination:e}})))),n.push.apply(n,f(i.map((function(t){var n=t.blob,r=t.folder,i=function(t){switch(t){case"image/png":return"png";case"image/jpg":case"image/jpeg":return"jpg";case"image/webp":return"webp";case"text/plain":return"txt";case"text/markdown":return"md";case"application/json":case"text/json":return"json";default:return console.warn('unknown file extension for type "'.concat(t,'"')),"none"}}(n.type),a=r||i;return o[a]=o[a]?o[a]+1:1,{destination:"".concat(a,"/").concat(e,".").concat(i),blob:n}}))))}));var i=["## Files in this repo:"].concat(f(Object.keys(o).map((function(t){return" * ".concat(t,": [").concat(o[t],"](/").concat(t,")")})))).join("\n");return e("remote").then((function(t){return n.push({destination:"README.md",blob:new Blob(f(i),{type:"text/plain"})},{destination:"settings.json",blob:new Blob(f(t),{type:"application/json"})}),{toUpload:n.filter(Boolean),toKeep:r.filter(Boolean)}}))}};function d(t){return function(t){if(Array.isArray(t))return b(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return b(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return b(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function b(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function y(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function m(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?y(Object(n),!0).forEach((function(e){g(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):y(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function g(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}e.a=function(t,e,n){var c=t.getState(),u=Object(r.a)(m(m({},c),{},{exportScaleFactors:[1],exportFileTypes:["txt"],handleExportFrame:"keep"})),l=p(t),f=[],h=c.images.filter((function(t){return!t.hashes})).map((function(t){return m(m({},t),{},{inRepo:[e.images.find((function(e){return e.name.substr(0,40)===t.hash}))].filter(Boolean)})})),b=h.length,y=c.frames.map((function(t){return m(m({},t),{},{inRepo:[e.frames.find((function(e){return e.name.match(/^[a-z]+[0-9]+/gi)[0]===t.id}))].filter(Boolean)})})),g=y.length;return Promise.all([].concat(d(h.map((function(t,e){return t.inRepo.length?m(m({},t),{},{inRepo:t.inRepo,files:[]}):n("loadImageTiles (".concat(e+1,"/").concat(b,") ").concat(t.title),3,(function(){return Object(o.a)(c)(t,!0).then((function(e){return e.length?u(Object(i.a)(c,t),t)(e).then((function(e){return m(m({},t),{},{files:e})})):(f.push(t.hash),Promise.resolve(null))}))}))}))),d(y.map((function(t,e){return t.inRepo.length?m(m({},t),{},{inRepo:t.inRepo,files:[]}):n("loadFrameData (".concat(e+1,"/").concat(g,") ").concat(t.id),3,(function(){return Object(a.a)(t.id).then((function(e){return m(m({},t),{},{hash:t.id,files:[{folder:"frames",filename:"",blob:new Blob(new Array(JSON.stringify(e||"{}",null,2)),{type:"application/json"}),title:t.name}]})}))}))}))))).then((function(t){return l(t.filter(Boolean))})).then((function(t){var n=t.toUpload,r=t.toKeep;return s(e,n,r,f)}))}},564:function(t,e){},566:function(t,e){},576:function(t,e){},578:function(t,e){},603:function(t,e){},605:function(t,e){},606:function(t,e){},611:function(t,e){},613:function(t,e){},620:function(t,e){},622:function(t,e){},640:function(t,e){},643:function(t,e){},659:function(t,e){},662:function(t,e){},668:function(t,e,n){"use strict";(function(t){n(131);var r=n(346),o=n.n(r);function i(t,e,n){this.overallHasher=t,this.blockHasher=e,this.blockPos=n}i.prototype.update=function(e,n){if(null===this.overallHasher)throw new Error("can't use this object anymore; you already called digest()");var r=e;if(!t.isBuffer(r)){if(void 0!==n&&"utf8"!==n&&"ascii"!==n&&"latin1"!==n)throw new Error("Invalid 'inputEncoding': ".concat(JSON.stringify(n)));r=t.from(e,n)}for(var i=0;i<r.length;){4194304===this.blockPos&&(this.overallHasher.update(this.blockHasher.digest()),this.blockHasher=o.a.createHash("sha256"),this.blockPos=0);var a=4194304-this.blockPos,c=Math.min(r.length,i+a),u=c-i;this.blockHasher.update(r.slice(i,c)),this.blockPos+=u,i=c}},i.prototype.digest=function(t){if(null===this.overallHasher)throw new Error("can't use this object anymore; you already called digest()");this.blockPos>0&&(this.overallHasher.update(this.blockHasher.digest()),this.blockHasher=null);var e=this.overallHasher.digest(t);return this.overallHasher=null,e},e.a=function(){return new i(o.a.createHash("sha256"),o.a.createHash("sha256"),0)}}).call(this,n(167).Buffer)},765:function(t,e,n){"use strict";n.r(e);n(65),n(165),n(53),n(141),n(181),n(38),n(25),n(68),n(182),n(67),n(89),n(92),n(90),n(91),n(93),n(54),n(14),n(26),n(66),n(39),n(37),n(137);var r=n(138),o=n.n(r),i=n(291),a=n(265),c=(n(133),n(134),n(135),n(136),n(171),n(131),n(216),n(224),n(250),n(251),n(252),n(253),n(55),n(132),n(175),n(94),n(173),n(111),n(561)),u=n(183),s=n(260),l=n(263);function f(t){return(f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function h(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var n=[],r=!0,o=!1,i=void 0;try{for(var a,c=t[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{r||null==c.return||c.return()}finally{if(o)throw i}}return n}(t,e)||d(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(t){return function(t){if(Array.isArray(t))return b(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||d(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(t,e){if(t){if("string"==typeof t)return b(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?b(t,e):void 0}}function b(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function y(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function m(t,e){return(m=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function g(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=O(t);if(e){var o=O(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return v(this,n)}}function v(t,e){return!e||"object"!==f(e)&&"function"!=typeof e?w(t):e}function w(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function O(t){return(O=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var j,x=encodeURIComponent("".concat(window.location.protocol,"//").concat(window.location.host).concat(window.location.pathname)),S=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&m(t,e)}(i,t);var e,n,r,o=g(i);function i(t,e){var n;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,i),(n=o.call(this)).queueCallback=e,n.throttle=30;var r=t.accessToken,a=t.expiresAt,u=t.refreshToken,s=t.path;return n.setRootPath(s),n.dbx=new c.Dropbox({clientId:"err6neqzlljod7b",accessToken:r,accessTokenExpiresAt:new Date(a),refreshToken:u}),window.dbx=n.dbx,n.requestError=n.requestError.bind(w(n)),n}return e=i,(n=[{key:"addToQueue",value:function(){return this.dbx.auth.getAccessToken()?this.queueCallback.apply(this,arguments):Promise.reject()}},{key:"setRootPath",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.rootPath=Object(l.a)(t).split("/")}},{key:"toPath",value:function(t){var e=[].concat(p(this.rootPath),p(t.split("/"))).filter(Boolean);return"/".concat(e.join("/"))}},{key:"inSettingsPath",value:function(t){var e=this.toPath("settings");return Object(l.a)(t.replace(e,""))}},{key:"checkLoginStatus",value:function(){var t=this;return this.dbx.auth.checkAndRefreshAccessToken().catch(this.requestError).then((function(){var e=t.dbx.auth.getAccessToken(),n=t.dbx.auth.getAccessTokenExpiresAt().getTime(),r=n-(new Date).getTime();return t.emit("loginDataUpdate",{accessToken:e,expiresAt:n}),e&&r>1e3})).catch((function(){return!1}))}},{key:"startAuth",value:function(){var t=this;this.dbx.auth.getAuthenticationUrl(x,void 0,"code","offline",void 0,void 0,!0).then((function(e){window.sessionStorage.setItem("dropboxCodeVerifier",t.dbx.auth.getCodeVerifier()),window.location.replace(e)}))}},{key:"codeAuth",value:function(t){var e=this;this.dbx.auth.setCodeVerifier(window.sessionStorage.getItem("dropboxCodeVerifier")),window.sessionStorage.removeItem("dropboxCodeVerifier"),this.dbx.auth.getAccessTokenFromCode(x,t).then((function(t){var n=t.result,r=n.refresh_token,o=n.access_token,i=n.expires_in,a=(new Date).getTime()+1e3*i;e.dbx.auth.setAccessToken(t.result.access_token),e.dbx.auth.setAccessTokenExpiresAt(new Date(a)),e.emit("loginDataUpdate",{refreshToken:r,accessToken:o,expiresAt:a})}))}},{key:"requestError",value:function(t){throw t.error.error_summary.startsWith("expired_access_token")&&(this.dbx.auth.setAccessTokenExpiresAt(new Date(0)),this.dbx.auth.setAccessToken(null)),new Error(t)}},{key:"getRemoteContents",value:function(){var t=this,e=["images","frames"];return this.checkLoginStatus().then((function(n){if(!n)throw new Error("not logged in");return t.addToQueue("dbx.filesDownload /settings.json",t.throttle,(function(){return t.dbx.filesDownload({path:t.toPath("/settings/settings.json")}).catch(t.requestError)})).catch((function(){return{result:{fileBlob:new Blob(p("{}"),{type:"text/plain"})}}})).then((function(n){var r=n.result.fileBlob;return Object(s.a)(r,"text").then((function(t){return JSON.parse(t)})).then((function(n){return Promise.all(e.map((function(e){return t.addToQueue("dbx.filesListFolder /".concat(e),t.throttle,(function(){return t.dbx.filesListFolder({path:t.toPath("/settings/".concat(e)),limit:250,recursive:!0}).catch(t.requestError)})).catch((function(){return{result:{entries:[],has_more:!1}}})).then((function(e){var n=e.result,r=n.entries,o=n.has_more,i=n.cursor;return(o?t.getMoreContents(i,r):Promise.resolve(r)).then((function(t){return t.filter((function(t){return"file"===t[".tag"]}))}))}))}))).then((function(e){var r=h(e,2),o=r[0],i=r[1];return{images:t.augmentFileList("images",o),frames:t.augmentFileList("frames",i),settings:n}}))}))}))}))}},{key:"getImageContents",value:function(){var t=this;return this.addToQueue("dbx.filesListFolder /images",this.throttle,(function(){return t.dbx.filesListFolder({path:t.toPath("/images"),limit:250,recursive:!0}).catch(t.requestError)})).catch((function(){return{result:{entries:[],has_more:!1}}})).then((function(e){var n=e.result,r=n.entries,o=n.has_more,i=n.cursor;return(o?t.getMoreContents(i,r):Promise.resolve(r)).then((function(t){return t.filter((function(t){return"file"===t[".tag"]}))}))}))}},{key:"getMoreContents",value:function(t,e){var n=this;return this.addToQueue("dbx.filesListFolderContinue ".concat(t),this.throttle,(function(){return n.dbx.filesListFolderContinue({cursor:t}).catch(n.requestError)})).then((function(t){var r=t.result,o=r.entries,i=r.has_more,a=r.cursor,c=e.concat(o);return i?n.getMoreContents(a,c):c}))}},{key:"augmentFileList",value:function(t,e){var n=this;return e.map((function(r,o){var i=r.path_lower,a=r.name,c=n.inSettingsPath(i),u={path:c,name:a,getFileContent:function(){return n.getFileContent(c,o,e.length)}};switch(t){case"images":return Object.assign(u,{hash:a.substr(0,40)});case"frames":return Object.assign(u,{id:a.match(/^[a-z]+[0-9]+/gi)[0]});default:return u}}))}},{key:"getFileContent",value:function(t,e,n){var r=this;return this.addToQueue("dbx.filesDownload (".concat(e+1,"/").concat(n,") ").concat(t),this.throttle,(function(){return r.dbx.filesDownload({path:r.toPath("/settings/".concat(t))}).catch(r.requestError)})).then((function(t){var e=t.result.fileBlob;return Object(s.a)(e,"text")}))}},{key:"upload",value:function(t,e){var n=this,r=t.upload,o=void 0===r?[]:r,i=t.del,a=void 0===i?[]:i;return Promise.all([o.length?Promise.all(o.map((function(t,r){return n.addToQueue("dbx.filesUpload (".concat(r+1,"/").concat(o.length,") ").concat(t.destination),n.throttle,(function(){return n.dbx.filesUpload({path:n.toPath("/".concat(e,"/").concat(t.destination)),contents:t.blob,mode:"overwrite"}).catch(n.requestError)})).then((function(t){return t.result}))}))):[],a.length?this.addToQueue("dbx.filesDeleteBatch ".concat(a.length," files"),this.throttle,(function(){return n.dbx.filesDeleteBatch({entries:a.map((function(t){var e=t.path;return{path:n.toPath("/settings/".concat(e))}}))}).catch(n.requestError)})).then((function(t){var e=t.result.async_job_id;return function t(){return n.addToQueue("dbx.filesDeleteBatchCheck ".concat(e),2e3,(function(){return n.dbx.filesDeleteBatchCheck({async_job_id:e}).catch(n.requestError)})).then((function(e){var n=e.result,r=n[".tag"],o=n.entries;return"in_progress"===r?t():o.map((function(t){return t.metadata}))}))}()})):[]]).then((function(t){var e=h(t,2),n=e[0],r=e[1];console.log({uploaded:n,deleted:r})}))}}])&&y(e.prototype,n),r&&y(e,r),i}(u.EventEmitter),A=n(668),P=(n(669),n(144),function(){var t=new URLSearchParams(window.location.search).get("code");return t?(window.history.replaceState({},document.title,"./"),window.location.replace("#/settings/dropbox"),{dropboxCode:t}):{}}),k=n(231),T=n(203),E=n(192),R=n(337),_=n(195);function C(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function D(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?C(Object(n),!0).forEach((function(e){I(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):C(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function I(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var B=function(){};e.default=function(t){var e=new o.a(1,1/0);B=function(n){return function(r,o,i){return e.add((function(){return new Promise((function(e,a){window.setTimeout((function(){t.dispatch({type:"DROPBOX_LOG_ACTION",payload:{timestamp:(new Date).getTime()/1e3,message:"".concat(n," runs ").concat(r)}}),i().then(e).catch(a)}),o)}))}))}},(j=new S(t.getState().dropboxStorage,B("Dropbox"))).on("loginDataUpdate",(function(e){t.dispatch({type:"SET_DROPBOX_STORAGE",payload:D(D({},t.getState().dropboxStorage),e)})}));var n=P().dropboxCode;return n&&j.codeAuth(n),function(e){if("SET_DROPBOX_STORAGE"===e.type&&j.setRootPath(t.getState().dropboxStorage.path||"/"),"STORAGE_SYNC_START"===e.type){if("dropbox"===e.payload.storageType)j.getRemoteContents().then((function(n){switch(e.payload.direction){case"up":return Object(i.a)(t,n,B("GBPrinter")).then((function(t){return j.upload(t,"settings")}));case"down":return Object(a.a)(n).then((function(e){return t.dispatch({type:"DROPBOX_SETTINGS_IMPORT",payload:n.settings}),e}));default:return Promise.reject(new Error("dropbox sync: wrong sync case"))}})).then((function(e){t.dispatch({type:"STORAGE_SYNC_DONE",payload:{syncResult:e,storageType:"dropbox"}})})).catch((function(e){console.error(e),t.dispatch({type:"ERROR",payload:e.message})}));else if("dropboximages"===e.payload.storageType){var n=t.getState(),r=Object(_.a)(n),o=Object(k.b)(n),c=Object(E.a)(n);Promise.all(r.map((function(t,e){return B("Generate images and hashes")("".concat(e,"/").concat(r.length),0,(function(){var e=Object(T.a)(n,t);return c(t).then(o(e,t)).then((function(t){return Promise.all(t.map((function(t){var e=Object(A.a)();return t.blob.arrayBuffer().then((function(n){return e.update(n),D(D({},t),{},{dropboxContentHash:e.digest("hex")})}))})))}))}))}))).then((function(t){return t.flat()})).then(R.a).then((function(t){return j.getImageContents().then((function(n){switch(e.payload.direction){case"up":var r=t.filter((function(t){var e=t.dropboxContentHash,r=t.uFilename;return!n.find((function(t){var n=t.content_hash,o=t.name;return n===e&&o===r}))})).map((function(t){return D(D({},t),{},{destination:t.uFilename})}));return j.upload({upload:r,del:[]},"images");default:return Promise.reject(new Error("dropbox sync: wrong sync case"))}}))})).then((function(e){t.dispatch({type:"STORAGE_SYNC_DONE",payload:{syncResult:e,storageType:"dropbox"}})})).catch((function(e){console.error(e),t.dispatch({type:"ERROR",payload:e.message})}))}}else"DROPBOX_START_AUTH"===e.type&&j.startAuth()}}}}]);