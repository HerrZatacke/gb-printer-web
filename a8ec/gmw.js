(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{534:function(t,e,n){"use strict";n.r(e),n.d(e,"init",(function(){return J})),n.d(e,"middleware",(function(){return Y})),n.d(e,"updateClient",(function(){return z}));n(99),n(86),n(19),n(20),n(137);var r=n(431),o=n.n(r),i=(n(83),n(89),n(90),n(105),n(95),n(147),n(96),n(84),n(97),n(93),n(92),n(117),n(100),n(118),n(119),n(146),n(120),n(87),n(88),n(85),n(434)),a=n.n(i),u=n(527),c=n(125),s=n.n(c),f=n(116);function l(t){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function h(t){return function(t){if(Array.isArray(t))return p(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return p(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return p(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function m(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function d(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function y(t,e){return(y=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function b(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=v(t);if(e){var o=v(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return g(this,n)}}function g(t,e){return!e||"object"!==l(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function v(t){return(v=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var w=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&y(t,e)}(i,t);var e,n,r,o=b(i);function i(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1?arguments[1]:void 0;return m(this,i),(t=o.call(this)).octoKit=null,t.busy=!1,t.owner=null,t.repo=null,t.branch=null,t.throttle=null,t.token=null,t.progress=0,t.queueLength=0,t.addToQueue=n,t.setOctokit(e),t}return e=i,(n=[{key:"setOctokit",value:function(t){var e=t.use,n=t.owner,r=t.repo,o=t.branch,i=t.throttle,a=t.token;if(this.busy||!e||!n||!r||!o||!i||!a)return this.octoKit=null,this.owner=null,this.repo=null,this.branch=null,this.throttle=null,void(this.token=null);this.owner=n,this.repo=r,this.branch=o,this.throttle=Math.max(parseInt(i,10)||0,10),this.token=a,this.octoKit=new u.a({auth:a})}},{key:"progressStart",value:function(t){this.queueLength=t+7,this.emit("starting",{progress:0,queueLength:this.queueLength}),this.progressTick()}},{key:"progressTick",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.progress=t?0:this.progress+1,this.emit("progress",{progress:this.progress,queueLength:this.queueLength}),t&&(this.queueLength=0)}},{key:"getRepoContents",value:function(){var t=this;this.progressTick();var e=[{path:"images",value:[]},{path:"palettes",value:[]},{path:"png",value:[]},{path:"frames",value:[]},{path:"settings.json",value:{}}];return this.addToQueue("repos.getContent /",this.throttle,(function(){return t.octoKit.repos.getContent({owner:t.owner,repo:t.repo,ref:"heads/".concat(t.branch),path:""})})).then((function(n){var r=n.data;return Promise.all(e.map((function(e){var n=e.path,o=e.value;return r.find((function(t){return t.path===n}))?t.addToQueue("repos.getContent /".concat(n),t.throttle,(function(){return t.octoKit.repos.getContent({owner:t.owner,repo:t.repo,ref:"heads/".concat(t.branch),path:n})})).then((function(t){var e=t.data;return{path:n,value:"file"===e.type?JSON.parse(atob(e.content)):e}})).catch((function(){return{path:n,value:o}})):Promise.resolve({path:n,value:o})}))).then((function(t){return{images:t.find((function(t){return"images"===t.path})).value,palettes:t.find((function(t){return"palettes"===t.path})).value,png:t.find((function(t){return"png"===t.path})).value,frames:t.find((function(t){return"frames"===t.path})).value,settings:t.find((function(t){return"settings.json"===t.path})).value}}))}))}},{key:"getBlob",value:function(t,e,n){var r=this;return this.progressTick(),this.addToQueue("git.getBlob (".concat(e+1,"/").concat(n,") ").concat(t),this.throttle,(function(){return r.octoKit.git.getBlob({owner:r.owner,repo:r.repo,file_sha:t})})).then((function(t){var e=t.data.content;return atob(e)}))}},{key:"getCurrentCommit",value:function(){var t=this;return this.progressTick(),this.addToQueue("git.getRef heads/".concat(this.branch),this.throttle,(function(){return t.octoKit.git.getRef({owner:t.owner,repo:t.repo,ref:"heads/".concat(t.branch)})})).then((function(e){var n=e.data.object.sha;return t.addToQueue("git.getCommit ".concat(n),t.throttle,(function(){return t.octoKit.git.getCommit({owner:t.owner,repo:t.repo,commit_sha:n})})).then((function(t){var e=t.data;return{commitSha:n,treeSha:e.tree.sha}}))}))}},{key:"createBlobForFile",value:function(t,e,n){var r=this,o=t.destination,i=t.blob;return this.progressTick(),new Promise((function(t){var e=new FileReader;e.onloadend=function(e){var n=e.target;t(n.result)},e.readAsDataURL(i)})).then((function(t){var i=t.indexOf(";base64,")+8,a=t.substr(i);return r.addToQueue("git.createBlob (".concat(e+1,"/").concat(n,") ").concat(o),r.throttle,(function(){return r.octoKit.git.createBlob({owner:r.owner,repo:r.repo,content:a,encoding:"base64"})})).then((function(t){var e=t.data;return{filename:o,blobData:e}}))}))}},{key:"createNewTree",value:function(t,e){var n=this,r=t.files,o=t.del;this.progressTick();var i=r.map((function(t){return{path:t.filename,mode:"100644",type:"blob",sha:t.blobData.sha}})),a=o.map((function(t){return{path:t.path,mode:"100644",sha:null}}));return this.addToQueue("git.createTree ".concat(e),this.throttle,(function(){return n.octoKit.git.createTree({owner:n.owner,repo:n.repo,tree:[].concat(h(i),h(a)),base_tree:e})})).then((function(t){return t.data}))}},{key:"createNewCommit",value:function(t,e,n){var r=this;return this.progressTick(),this.addToQueue("git.createCommit ".concat(t),this.throttle,(function(){return r.octoKit.git.createCommit({owner:r.owner,repo:r.repo,message:t,tree:e,parents:[n]})})).then((function(t){return t.data}))}},{key:"setBranchToCommit",value:function(t){var e=this;return this.progressTick(),this.addToQueue("git.updateRef ".concat(t),this.throttle,(function(){return e.octoKit.git.updateRef({owner:e.owner,repo:e.repo,ref:"heads/".concat(e.branch),sha:t})})).then((function(t){return t.data}))}},{key:"uploadToRepo",value:function(t){var e=this,n=t.upload,r=t.del;if(!this.octoKit)return Promise.reject(new Error("OctoClient not configured"));var o="Sync. ".concat(s()().format(f.d)),i=n.length;return this.getCurrentCommit().then((function(t){var a=t.treeSha,u=t.commitSha;return Promise.all(n.map((function(t,n){return e.createBlobForFile(t,n,i)}))).then((function(t){return e.createNewTree({files:t,del:r},a)})).then((function(t){var n=t.sha;return e.createNewCommit(o,n,u)})).then((function(t){var n=t.sha;return e.setBranchToCommit(n)}))}))}},{key:"updateRemoteStore",value:function(t){var e=this,n=t.upload,r=void 0===n?[]:n,o=t.del,i=void 0===o?[]:o;return this.busy?Promise.reject(Error("currently busy")):r.length||i.length?(this.progressStart(r.length),this.busy=!0,this.uploadToRepo({upload:r,del:i}).then((function(){return e.progressTick(!0),e.busy=!1,{uploaded:r.map((function(t){return t.destination})),deleted:i.map((function(t){return t.path})),repo:"https://github.com/".concat(e.owner,"/").concat(e.repo,"/tree/").concat(e.branch)}})).catch((function(t){throw e.busy=!1,e.emit("error",t),t}))):Promise.resolve({})}}])&&d(e.prototype,n),r&&d(e,r),i}(a.a),O=(n(94),n(101),n(110),n(108),n(111),n(107),n(102),n(189)),j=n(163),S=n(166),T=n(165);function A(t){return function(t){if(Array.isArray(t))return k(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return k(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return k(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function k(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function C(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function P(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?C(Object(n),!0).forEach((function(e){R(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):C(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function R(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var I=function(t,e){var n=Object(O.a)(P(P({},t),{},{exportScaleFactors:[1],exportFileTypes:["png","txt"],exportCropFrame:!1})),r=[],o=t.images.length,i=t.frames.length;return Promise.all([].concat(A(t.images.map((function(i,a){return e("loadImageTiles (".concat(a+1,"/").concat(o,") ").concat(i.title),3,(function(){return Object(j.a)(i,t,!0).then((function(e){return e.length?n(Object(S.a)(t,i),i)(e).then((function(t){return P(P({},i),{},{files:t})})):(r.push(i.hash),Promise.resolve(null))}))}))}))),A(t.frames.map((function(t,n){return e("loadFrameData (".concat(n+1,"/").concat(i,") ").concat(t.id),3,(function(){return Object(T.a)(t.id).then((function(e){return P(P({},t),{},{hash:t.id,files:[{folder:"frames",filename:"",blob:new Blob(new Array(JSON.stringify(e||"{}",null,2)),{type:"application/json"}),title:t.name}]})}))}))}))))).then((function(t){return{imageCollection:t.filter(Boolean),missingLocally:r}}))},E=(n(123),n(442)),_=n.n(E),B=n(233);function x(t){return function(t){if(Array.isArray(t))return D(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return D(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return D(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function D(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var K=function(t){var e=[],n={};t.forEach((function(t){var r=t.hash,o=t.files,i=t.hashes;e.push.apply(e,x(o.map((function(t){var e=t.blob,o=t.title,a=t.folder,u=_.a.extension(e.type),c=a||u;return n[c]=n[c]?n[c]+1:1,{destination:"".concat(c,"/").concat(r,".").concat(u),blob:e,extension:u,title:o,hash:i?null:r}}))))}));var r=e.filter((function(t){return"png"===t.extension})).map((function(t){var e=t.destination,n=t.hash,r=t.title;return n?"[![".concat(r,"](").concat(e,' "').concat(r,'")](images/').concat(n,".txt)"):"![".concat(r,"](").concat(e,' "').concat(r,'")')})).join("\n"),o=["## Files in this repo:"].concat(x(Object.keys(n).map((function(t){return" * ".concat(t,": [").concat(n[t],"](/").concat(t,")")}))),["## Images:",r]).join("\n"),i=Object(B.a)("remote");return e.push({destination:"README.md",blob:new Blob(x(o),{type:"text/plain"})},{destination:"settings.json",blob:new Blob(x(i),{type:"application/json"})}),e.filter(Boolean)};function N(t){return function(t){if(Array.isArray(t))return L(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return L(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return L(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function L(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var F=function(t,e,n){var r=t.images,o=t.png,i=t.palettes,a=t.frames;return{upload:e.filter((function(t){var e=t.destination;return!(r.find((function(t){return t.path===e}))||i.find((function(t){return t.path===e}))||o.find((function(t){return t.path===e}))||a.find((function(t){return t.path===e})))})),del:[].concat(N([].concat(N(r),N(o)).filter((function(t){var r=t.path;return!e.find((function(t){var e=t.destination;return r===e}))&&!n.find((function(t){return r.indexOf(t)>=-1}))}))),N([].concat(N(i),N(a)).filter((function(t){var n=t.path;return!e.find((function(t){var e=t.destination;return n===e}))}))))}},Q=(n(219),n(134),n(135),n(106),n(133),n(124),n(128));function G(t){return function(t){if(Array.isArray(t))return M(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return M(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return M(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function M(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var q,U=function(t){return function(e){var n=e.images,r=e.frames,o=n.length,i=r.length;return Promise.all([].concat(G(n.map((function(e,n){var r=e.name.substr(0,40);return Object(Q.b)(r,null,!0).then((function(i){return i.length?r:t.getBlob(e.sha,n,o).then((function(t){var e=t.split("\n").filter((function(t){return t.match(/^[0-9a-f ]+$/gi)}));return Object(Q.c)(e)}))}))}))),G(r.map((function(e,n){var r=e.name.match(/^[a-z]+[0-9]+/gi)[0];return Object(T.a)(r).then((function(o){return o?r:t.getBlob(e.sha,n,i).then((function(t){var e=JSON.parse(t,null,2),n=Array(32).fill("f").join(""),o=Array(16).fill(n),i=[].concat(G(e.upper),G(Array(14).fill().map((function(t,n){return[].concat(G(e.left[n]),G(o),G(e.right[n]))})).flat()),G(e.lower));return Object(T.b)(r,i)}))}))})))))}},$=function(){},J=function(t){var e=t.getState().gitStorage,n=new o.a(1,1/0);q=new w(e,($=function(e){return function(r,o,i){return n.add((function(){return new Promise((function(n,a){window.setTimeout((function(){t.dispatch({type:"GITSTORAGE_LOG_ACTION",payload:{timestamp:(new Date).getTime()/1e3,message:"".concat(e," runs ").concat(r)}}),i().then(n).catch(a)}),o)}))}))}})("OctoClient"))},Y=function(t){return function(e){if("GITSTORAGE_SYNC_START"===e.type){var n=t.getState();q.getRepoContents().then((function(r){switch(e.payload){case"up":return I(n,$("GBPrinter")).then((function(t){var e=t.missingLocally,n=t.imageCollection,o=K(n);return F(r,o,e)})).then((function(t){return q.updateRemoteStore(t)}));case"down":return U(q)(r).then((function(e){return t.dispatch({type:"SETTINGS_IMPORT",payload:r.settings}),e}));default:return Promise.reject(new Error("wrong sync case"))}})).catch((function(e){return console.error(e),t.dispatch({type:"ERROR",payload:e.message}),e.message})).then((function(e){t.dispatch({type:"GITSTORAGE_SYNC_DONE",payload:e})}))}}},z=function(t){q.setOctokit(t)}}}]);