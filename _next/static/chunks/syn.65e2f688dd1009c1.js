"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1575],{5672:(t,e,n)=>{n.d(e,{A:()=>o,Z:()=>a});var r=n(49641).Buffer,a=function(t){return t.UINT8_ARRAY="uint8array",t.TEXT="text",t.DATA_URL="dataURL",t.BINARY_STRING="binaryString",t}({});let o=function(t,e){return new Promise(function(n,a){var o=new FileReader;switch(o.onload=function(t){var o=t.target;if(null==o?void 0:o.result)return"uint8array"===e?void n(r.from(o.result)):void n(o.result);a(Error("Filereader has no result"))},o.onerror=function(t){a(t)},e){case"uint8array":o.readAsArrayBuffer(t);break;case"text":o.readAsText(t);break;case"binaryString":o.readAsBinaryString(t);break;case"dataURL":o.readAsDataURL(t);break;default:a(Error('readAs param missing or unknown type "'.concat(e,'"')))}})}},10630:(t,e,n)=>{n.r(e),n.d(e,{gitSyncTool:()=>k,init:()=>L});var r,a,o=n(97004),s=n(39249),i=n(58617),u=n.n(i),c=n(46498),l=n(41476),h=n(52166),f=n(24463),p=n(74335),d=n(19320),g=n(17419),m=n(26002),v=n(65492),b=n(66214),w=n(577),_=n(40662),y=n.n(_),A=n(67660),T=n(30832),S=n.n(T),H=n(5672),x=n(49967),C=function(t){function e(t,n,r){var a;return(0,v._)(this,e),(a=(0,m._)(this,e)).octoKit=null,a.busy=!1,a.owner="",a.repo="",a.branch="",a.throttle=10,a.token=null,a.progress=0,a.queueLength=0,a.addToQueue=r,a.getPreferredLocale=n,a.setOctokit(t||{}),a}(0,b._)(e,t);var n=e.prototype;return n.setOctokit=function(t){var e=t.use,n=t.owner,r=t.repo,a=t.branch,o=t.throttle,s=t.token;if(this.busy||!e||!n||!r||!a||!o||!s){this.octoKit=null,this.owner="",this.repo="",this.branch="",this.throttle=10,this.token=null;return}this.owner=n,this.repo=r,this.branch=a,this.throttle=Math.max(o,10)||10,this.token=s,this.octoKit=new A.E({auth:s})},n.progressStart=function(t){this.queueLength=t+7,this.emit("starting",{progress:0,queueLength:this.queueLength}),this.progressTick()},n.progressTick=function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.progress=t?0:this.progress+1,this.emit("progress",{progress:this.progress,queueLength:this.queueLength}),t&&(this.queueLength=0)},n.getRepoContents=function(){var t=this;return(0,o._)(function(){var e,n,r,a,o,i,u;return(0,s.YH)(this,function(s){switch(s.label){case 0:return t.progressTick(),[4,t.addToQueue("repos.getBranch ".concat(t.branch),t.throttle,function(){var e;return null==(e=t.octoKit)?void 0:e.repos.getBranch({owner:t.owner,repo:t.repo,branch:t.branch})})];case 1:return e=s.sent().data.commit.sha,[4,t.addToQueue("git.getCommit ".concat(e),t.throttle,function(){var n;return null==(n=t.octoKit)?void 0:n.git.getCommit({owner:t.owner,repo:t.repo,commit_sha:e})})];case 2:return n=s.sent().data.tree.sha,[4,t.addToQueue("git.getTree ".concat(n),t.throttle,function(){var e;return null==(e=t.octoKit)?void 0:e.git.getTree({owner:t.owner,repo:t.repo,tree_sha:n,recursive:"1"})})];case 3:if(a=(r=s.sent().data.tree).find(function(t){return"settings.json"===t.path}),o=t.augmentFileList("images",r.filter(function(t){var e=t.path;return null==e?void 0:e.startsWith("images/")})),i=t.augmentFileList("frames",r.filter(function(t){var e=t.path;return null==e?void 0:e.startsWith("frames/")})),!(null==a?void 0:a.sha))return[3,5];return[4,t.getFileContent(a.sha,0,1)];case 4:return u=s.sent(),[3,6];case 5:u="{}",s.label=6;case 6:return[2,{images:o,frames:i,settings:JSON.parse(u)}]}})})()},n.augmentFileList=function(t,e){var n=this;return e.reduce(function(r,a,o){var s,i=a.path,u=a.sha;if(!i||!u)return r;var c=i.split("/").pop()||"";switch(t){case"images":case"frames":s=c.split(".")[0];break;default:s="-"}var l={path:i,name:c,hash:s,getFileContent:function(){return n.getFileContent(u,o,e.length)}};return(0,w._)(r).concat([l])},[])},n.getFileContent=function(t,e,n){var r=this;return(0,o._)(function(){return(0,s.YH)(this,function(a){switch(a.label){case 0:return r.progressTick(),[4,r.addToQueue("git.getBlob (".concat(e+1,"/").concat(n,") ").concat(t),r.throttle,function(){var e;return null==(e=r.octoKit)?void 0:e.git.getBlob({owner:r.owner,repo:r.repo,file_sha:t})})];case 1:var o;return[2,(o=a.sent().data.content,decodeURIComponent(Array.prototype.map.call(atob(o),function(t){return"%".concat("00".concat(t.charCodeAt(0).toString(16)).slice(-2))}).join("")))]}})})()},n.getCurrentCommit=function(){var t=this;return(0,o._)(function(){var e,n;return(0,s.YH)(this,function(r){switch(r.label){case 0:return t.progressTick(),[4,t.addToQueue("git.getRef heads/".concat(t.branch),t.throttle,function(){var e;return null==(e=t.octoKit)?void 0:e.git.getRef({owner:t.owner,repo:t.repo,ref:"heads/".concat(t.branch)})})];case 1:return e=r.sent().data.object.sha,[4,t.addToQueue("git.getCommit ".concat(e),t.throttle,function(){var n;return null==(n=t.octoKit)?void 0:n.git.getCommit({owner:t.owner,repo:t.repo,commit_sha:e})})];case 2:return n=r.sent().data,[2,{commitSha:e,treeSha:n.tree.sha}]}})})()},n.createBlobForFile=function(t,e,n){var r=t.destination,a=t.blob,i=this;return(0,o._)(function(){var t,o,u;return(0,s.YH)(this,function(s){switch(s.label){case 0:return i.progressTick(),[4,(0,H.A)(a,H.Z.DATA_URL)];case 1:return o=(t=s.sent()).indexOf(";base64,")+8,u=t.slice(o),[4,i.addToQueue("git.createBlob (".concat(e+1,"/").concat(n,") ").concat(r),i.throttle,function(){var t;return null==(t=i.octoKit)?void 0:t.git.createBlob({owner:i.owner,repo:i.repo,content:u,encoding:"base64"})})];case 2:return[2,{filename:r,blobData:s.sent().data}]}})})()},n.createNewTree=function(t,e,n){var r=this;return(0,o._)(function(){var a,o;return(0,s.YH)(this,function(s){switch(s.label){case 0:return r.progressTick(),a=t.map(function(t){return{path:t.filename,mode:"100644",type:"blob",sha:t.blobData.sha}}),o=e.map(function(t){return{path:t.path,mode:"100644",sha:null}}),[4,r.addToQueue("git.createTree ".concat(n),r.throttle,function(){var t;return null==(t=r.octoKit)?void 0:t.git.createTree({owner:r.owner,repo:r.repo,tree:(0,w._)(a).concat((0,w._)(o)),base_tree:n})})];case 1:return[2,s.sent().data.sha]}})})()},n.createNewCommit=function(t,e,n){var r=this;return(0,o._)(function(){return(0,s.YH)(this,function(a){switch(a.label){case 0:return r.progressTick(),[4,r.addToQueue("git.createCommit ".concat(t),r.throttle,function(){var a;return null==(a=r.octoKit)?void 0:a.git.createCommit({owner:r.owner,repo:r.repo,message:t,tree:e,parents:[n]})})];case 1:return[2,a.sent().data.sha]}})})()},n.setBranchToCommit=function(t){var e=this;return(0,o._)(function(){return(0,s.YH)(this,function(n){switch(n.label){case 0:return e.progressTick(),[4,e.addToQueue("git.updateRef ".concat(t),e.throttle,function(){var n;return null==(n=e.octoKit)?void 0:n.git.updateRef({owner:e.owner,repo:e.repo,ref:"heads/".concat(e.branch),sha:t})})];case 1:return n.sent(),[2]}})})()},n.uploadToRepo=function(t){var e=t.upload,n=t.del,r=this;return(0,o._)(function(){var t,a,o,i,u,c,l,h;return(0,s.YH)(this,function(s){switch(s.label){case 0:if(!r.octoKit)throw Error("OctoClient not configured");return t="Sync. ".concat((0,x.A)(S()(),r.getPreferredLocale())),a=e.length,[4,r.getCurrentCommit()];case 1:return i=(o=s.sent()).treeSha,u=o.commitSha,[4,Promise.all(e.map(function(t,e){return r.createBlobForFile(t,e,a)}))];case 2:return c=s.sent(),[4,r.createNewTree(c,n,i)];case 3:return l=s.sent(),[4,r.createNewCommit(t,l,u)];case 4:return h=s.sent(),[4,r.setBranchToCommit(h)];case 5:return s.sent(),[2]}})})()},n.updateRemoteStore=function(t){var e=t.upload,n=t.del,r=this;return(0,o._)(function(){var t;return(0,s.YH)(this,function(a){switch(a.label){case 0:if(a.trys.push([0,2,,3]),r.busy)throw Error("currently busy");if(!e.length&&!n.length)return[2,{}];return r.progressStart(e.length),r.busy=!0,[4,r.uploadToRepo({upload:e,del:n})];case 1:return a.sent(),r.busy=!1,r.progressTick(!0),[2,{uploaded:e.map(function(t){return t.destination}),deleted:n.map(function(t){return t.path}),repo:"https://github.com/".concat(r.owner,"/").concat(r.repo,"/tree/").concat(r.branch)}];case 2:throw t=a.sent(),r.busy=!1,r.emit("error",t),t;case 3:return[2]}})})()},e}(y()),L=function(){var t=f.A.getState().gitStorage,e=l.A.getState().setProgressLog,n=new(u())(1,1/0);r=new C(t,function(){return h.A.getState().preferredLocale},(a=function(t){return function(r,a,i){return n.add((0,o._)(function(){return(0,s.YH)(this,function(n){switch(n.label){case 0:return[4,(0,p.c)(a)];case 1:return n.sent(),e("git",{timestamp:new Date().getTime()/1e3,message:"".concat(t," runs ").concat(r)}),[2,i()]}})}))}})("OctoClient"))},k=function(t){var e,n,i=c.A.getState(),u=i.setSyncBusy,h=i.setSyncSelect,p=l.A.getState().setProgressLog,m=f.A.getState().syncLastUpdate,v=(e=(0,o._)(function(t){return(0,s.YH)(this,function(e){switch(e.label){case 0:return[4,r.setOctokit(t)];case 1:return e.sent(),[2]}})}),function(t){return e.apply(this,arguments)}),b=(n=(0,o._)(function(e){var n,o,i,l;return(0,s.YH)(this,function(s){switch(s.label){case 0:u(!0),h(!1),s.label=1;case 1:return s.trys.push([1,10,,11]),[4,r.getRepoContents()];case 2:switch(n=s.sent(),e){case"up":return[3,3];case"down":return[3,6]}return[3,8];case 3:return o=(null==m?void 0:m.local)||Math.floor(new Date().getTime()/1e3),[4,(0,d.A)(n,o,a("GBPrinter"))];case 4:return i=s.sent(),[4,r.updateRemoteStore(i)];case 5:return s.sent(),[3,9];case 6:return[4,(0,g.Ay)(n)];case 7:return t(s.sent()),[3,9];case 8:throw Error("github sync: wrong sync case");case 9:return p("git",{timestamp:new Date().getTime()/1e3,message:"."}),u(!1),[3,11];case 10:return console.error(l=s.sent()),c.A.getState().setError(l),[3,11];case 11:return[2]}})}),function(t){return n.apply(this,arguments)});return f.A.subscribe(function(t){return t.gitStorage},v),{startSyncData:b,updateSettings:v}}},17419:(t,e,n)=>{n.d(e,{Ay:()=>g,L2:()=>p,_K:()=>f});var r=n(97004),a=n(693),o=n(60376),s=n(577),i=n(39249),u=n(53982),c=n(55364),l=n(99451),h=n(72623),f=function(){var t=(0,r._)(function(t){var e;return(0,i.YH)(this,function(n){return e=t.split("\n").filter(function(t){return t.match(/^[0-9a-f ]+$/gi)}),[2,(0,h.UN)(e)]})});return function(e){return t.apply(this,arguments)}}(),p=function(t){var e=Array(32).fill("f").join(""),n=Array(16).fill(e);return(0,s._)(t.upper).concat((0,s._)(Array(14).fill("").map(function(e,r){return(0,s._)(t.left[r]).concat((0,s._)(n),(0,s._)(t.right[r]))}).flat()),(0,s._)(t.lower))},d=function(){var t=(0,r._)(function(t){var e,n,r;return(0,i.YH)(this,function(a){return n=(e=JSON.parse(t)).upper.length/20,r=p(e),[2,(0,u.R_)(r,n)]})});return function(e){return t.apply(this,arguments)}}();let g=function(){var t=(0,r._)(function(t){var e,n,s,p,g,m,v,b,w;return(0,i.YH)(this,function(_){var y,A;switch(_.label){case 0:return e=t.images,n=t.frames,p=(s=t.settings).state.images||[],g=s.state.frames||[],[4,Promise.all(e.map((y=(0,r._)(function(t){var e,n;return(0,i.YH)(this,function(r){switch(r.label){case 0:return[4,(0,h.Hh)(t.hash,void 0,!0)];case 1:if(null==(e=r.sent())?void 0:e.length)return[2,void 0];return[4,t.getFileContent()];case 2:return[4,f(r.sent())];case 3:if(n=r.sent(),t.hash!==n)return[2,{oldHash:t.hash,newHash:n}];return[2,void 0]}})}),function(t){return y.apply(this,arguments)})))];case 1:return m=_.sent().reduce(l.N,[]),[4,Promise.all(n.map((A=(0,r._)(function(t){var e;return(0,i.YH)(this,function(n){switch(n.label){case 0:return[4,(0,u.mZ)(t.hash)];case 1:if(n.sent())return[2,void 0];return[4,t.getFileContent()];case 2:return[4,d(n.sent())];case 3:if(e=n.sent(),t.hash!==e)return[2,{oldHash:t.hash,newHash:e}];return[2,void 0]}})}),function(t){return A.apply(this,arguments)})))];case 2:return v=_.sent().reduce(l.N,[]),b=p.map(function(t){if((0,c.pl)(t)){var e=(0,a._)({},t.hashes),n=m.find(function(e){return e.oldHash===t.hashes.r}),r=m.find(function(e){return e.oldHash===t.hashes.g}),s=m.find(function(e){return e.oldHash===t.hashes.b}),i=m.find(function(e){return e.oldHash===t.hashes.n});return(null==n?void 0:n.newHash)&&(e.r=null==n?void 0:n.newHash),(null==r?void 0:r.newHash)&&(e.g=null==r?void 0:r.newHash),(null==s?void 0:s.newHash)&&(e.b=null==s?void 0:s.newHash),(null==i?void 0:i.newHash)&&(e.n=null==i?void 0:i.newHash),(0,o._)((0,a._)({},t),{hashes:e})}var u=m.find(function(e){return e.oldHash===t.hash});return(0,o._)((0,a._)({},t),{hash:(null==u?void 0:u.newHash)||t.hash})}),w=g.map(function(t){var e=v.find(function(e){return e.oldHash===t.hash});return e?(0,o._)((0,a._)({},t),{hash:e.newHash}):t}),[2,(0,o._)((0,a._)({},s),{state:(0,o._)((0,a._)({},s.state),{images:b,frames:w})})]}})});return function(e){return t.apply(this,arguments)}}()},19320:(t,e,n)=>{n.d(e,{A:()=>_});var r=n(97004),a=n(577),o=n(39249);let s=function(t,e,n,r){var o=t.images,s=t.frames,i=o.filter(function(t){var a=t.path;return!n.find(function(t){return a===t.destination})&&!e.find(function(t){return a===t.destination})&&!r.find(function(t){return a.indexOf(t)>=-1})}),u=s.filter(function(t){var r=t.path;return!n.find(function(t){return r===t.destination})&&!e.find(function(t){return r===t.destination})});return{upload:e.filter(function(t){var e=t.destination;return!o.find(function(t){return t.path===e})&&!s.find(function(t){return t.path===e})}),del:(0,a._)(i).concat((0,a._)(u))}};var i=n(69229),u=n(69176),c=function(t){switch(t){case"image/png":return"png";case"image/jpg":case"image/jpeg":return"jpg";case"image/webp":return"webp";case"text/plain":return"txt";case"text/markdown":return"md";case"application/json":case"text/json":return"json";default:return console.warn('unknown file extension for type "'.concat(t,'"')),"none"}};let l=function(){var t;return t=(0,r._)(function(t,e){var n,r,s,l,h;return(0,o.YH)(this,function(o){switch(o.label){case 0:return n=[],r=[],s={},t.forEach(function(t){var e,o,i=t.files,u=t.inRepo;(e=r).push.apply(e,(0,a._)(u.map(function(t){var e=t.path,n=e.split("/")[0];return s[n]=s[n]?s[n]+1:1,{destination:e}}))),(o=n).push.apply(o,(0,a._)(i.map(function(t){var e=t.blob,n=t.folder,r=t.filename,a=c(e.type),o=n||a;return s[o]=s[o]?s[o]+1:1,{destination:"".concat(o,"/").concat(r),blob:e}})))}),l=["## Files in this repo:"].concat((0,a._)(Object.keys(s).map(function(t){return" * ".concat(t,": [").concat(s[t],"](/").concat(t,")")}))).join("\n"),[4,(0,u.m)(i.m.JSON_EXPORT,{lastUpdateUTC:e})];case 1:return h=o.sent(),n.push({destination:"README.md",blob:new Blob((0,a._)(l),{type:"text/plain"})},{destination:"settings.json",blob:new Blob((0,a._)(h),{type:"application/json"})}),[2,{toUpload:n.filter(Boolean),toKeep:r.filter(Boolean)}]}})}),function(e,n){return t.apply(this,arguments)}};var h=n(693),f=n(60376),p=n(11760),d=n(53982),g=function(){var t=(0,r._)(function(t,e){var n,a,s;return(0,o.YH)(this,function(i){switch(i.label){case 0:return n=[],s=(a=p.h.getState().frames.map(function(e){return{file:e,searchHashes:[e.hash],inRepo:[t.frames.find(function(t){return t.hash===e.hash})].filter(Boolean)}})).length,[4,Promise.all(a.map(function(t,n){var a=t.file;return t.inRepo.length?(0,f._)((0,h._)({},a),{inRepo:t.inRepo,files:[]}):e("loadFrameData (".concat(n+1,"/").concat(s,") ").concat(a.id),3,(0,r._)(function(){var e;return(0,o.YH)(this,function(n){switch(n.label){case 0:return[4,(0,d.mZ)(a.hash)];case 1:return e=n.sent(),[2,(0,f._)((0,h._)({},a),{inRepo:t.inRepo,files:[{folder:"frames",filename:"".concat(a.hash,".json"),blob:new Blob(Array(JSON.stringify(e||"{}",null,2)),{type:"application/json"}),title:a.name}]})]}})}))}))];case 1:return[2,{syncFrames:i.sent().filter(Boolean),missingLocally:n}]}})});return function(e,n){return t.apply(this,arguments)}}(),m=n(2608),v=n(55364),b=n(55685),w=function(){var t=(0,r._)(function(t,e){var n,s,i;return(0,o.YH)(this,function(u){switch(u.label){case 0:var c;return n=[],i=(s=p.h.getState().images.map(function(e){var n=(0,v.pl)(e)?(0,b.A)(Object.values(e.hashes)).filter(Boolean):[e.hash];return{file:e,searchHashes:n,inRepo:t.images.reduce(function(t,e){return n.includes(e.hash)?(0,a._)(t).concat([e]):t},[])}})).length,[4,Promise.all(s.map((c=(0,r._)(function(t,n){return(0,o.YH)(this,function(a){return t.inRepo.length===t.searchHashes.length?[2,{hash:t.file.hash,inRepo:t.inRepo,files:[]}]:[2,e("loadImageTiles (".concat(n+1,"/").concat(i,") ").concat(t.file.title),3,(0,r._)(function(){var e,n,r;return(0,o.YH)(this,function(a){switch(a.label){case 0:if(!(0,v.pl)(t.file))return[3,2];return[4,Promise.all(Object.values((n=t.file).hashes).map(function(t){return(0,m.Z)(t,n.title,t)}))];case 1:return e=a.sent(),[3,4];case 2:return r=t.file,[4,(0,m.Z)(r.hash,r.title,r.hash)];case 3:e=[a.sent()],a.label=4;case 4:return[2,{hash:t.file.hash,files:e,inRepo:t.inRepo}]}})}))]})}),function(t,e){return c.apply(this,arguments)})))];case 1:return[2,{syncImages:u.sent().filter(Boolean),missingLocally:n}]}})});return function(e,n){return t.apply(this,arguments)}}();let _=function(){var t=(0,r._)(function(t,e,n){var r,i,u,c,h,f,p,d,m,v,b,_;return(0,o.YH)(this,function(o){switch(o.label){case 0:return u=l(),c=[],[4,w(t,n)];case 1:return f=(h=o.sent()).syncImages,p=h.missingLocally,(r=c).push.apply(r,(0,a._)(p)),[4,g(t,n)];case 2:return m=(d=o.sent()).syncFrames,v=d.missingLocally,(i=c).push.apply(i,(0,a._)(v)),b=(0,a._)(f).concat((0,a._)(m)),[4,u(b,e)];case 3:return[2,s(t,(_=o.sent()).toUpload,_.toKeep,c)]}})});return function(e,n,r){return t.apply(this,arguments)}}()},41476:(t,e,n)=>{n.d(e,{A:()=>u});var r=n(86447),a=n(693),o=n(60376),s=n(577),i=n(51368);let u=(0,n(65453).v)(function(t,e){return{progress:[],progressLog:{git:[],dropbox:[]},resetProgressLog:function(){return t({progressLog:{git:[],dropbox:[]}})},startProgress:function(e){var n={id:(0,i.A)(),label:e,value:0};return t(function(t){var e=t.progress;return{progress:(0,s._)(e).concat([n])}}),n.id},setProgress:function(e,n){t(function(t){return{progress:t.progress.map(function(t){return t.id!==e?t:(0,o._)((0,a._)({},t),{value:n})})}})},stopProgress:function(e){t(function(t){return{progress:t.progress.filter(function(t){return t.id!==e})}})},setProgressLog:function(n,i){var u=e().progressLog;t({progressLog:(0,o._)((0,a._)({},u),(0,r._)({},n,[i].concat((0,s._)(u[n]))))})}}})},74335:(t,e,n)=>{n.d(e,{c:()=>o});var r=n(97004),a=n(39249),o=function(){var t=(0,r._)(function(t){return(0,a.YH)(this,function(e){return[2,new Promise(function(e){self.setTimeout(e,t)})]})});return function(e){return t.apply(this,arguments)}}()},93782:(t,e,n)=>{n.d(e,{A:()=>r});let r=function(t){return t.replace(/[^a-z0-9/\\._-]/gi,"").replace(/[\\/]+/gi,"/").replace(/^\//,"").replace(/\/$/,"")}},94979:(t,e,n)=>{n.r(e),n.d(e,{dropBoxSyncTool:()=>q});var r=n(97004),a=n(693),o=n(60376),s=n(577),i=n(39249),u=n(30832),c=n.n(u),l=n(58617),h=n.n(l),f=n(39630),p=n(41186),d=n(71620),g=n(46498),m=n(11760),v=n(41476),b=n(52166),w=n(24463),_=n(49967),y=n(74335),A=n(5415),T=n(66785),S=n(19320),H=n(5847);let x=function(){var t=new URLSearchParams(window.location.search).get("code");return t?(window.history.replaceState({},"",window.location.pathname),{dropboxCode:t}):{}};var C=n(31533),L=n(17419),k=n(53982),Y=n(26002),P=n(65492),R=n(66214),D=n(62570),U=n(40662),B=n(87422),F=n(93782),E=n(5672),j=encodeURIComponent("".concat(window.location.protocol,"//").concat(window.location.host).concat(window.location.pathname)),Q=function(t){function e(t,n){(0,P._)(this,e),(r=(0,Y._)(this,e)).queueCallback=n,r.throttle=30,r.rootPath=[];var r,a,o=t.accessToken,s=t.expiresAt,i=t.refreshToken,u=t.path,c=t.autoDropboxSync;r.setRootPath(u),r.dbx=new B.Dropbox({clientId:"err6neqzlljod7b",accessToken:o,accessTokenExpiresAt:new Date(s||0),refreshToken:i});var l=null==(a=r.dbx)?void 0:a.auth;if(!l)throw Error("dbx auth error");return r.auth=l,c&&r.startLongPollSettings(),r}(0,R._)(e,t);var n=e.prototype;return n.addToQueue=function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];var a=this;return(0,r._)(function(){return(0,i.YH)(this,function(t){if(!a.auth.getAccessToken())throw Error("not logged in");return[2,a.queueCallback.apply(a,(0,s._)(e))]})})()},n.setRootPath=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.rootPath=(0,F.A)(t).split("/")},n.toPath=function(t){var e=(0,s._)(this.rootPath).concat((0,s._)(t.split("/"))).filter(Boolean);return"/".concat(e.join("/"))},n.inSettingsPath=function(t){var e=this.toPath("settings");return(0,F.A)(t.replace(e,""))},n.checkLoginStatus=function(){var t=this;return(0,r._)(function(){var e,n,r,a;return(0,i.YH)(this,function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,t.auth.checkAndRefreshAccessToken()];case 1:return o.sent(),e=t.auth.getAccessToken(),r=(n=t.auth.getAccessTokenExpiresAt().getTime())-new Date().getTime(),t.emit("loginDataUpdate",{accessToken:e,expiresAt:n}),[2,!!e&&r>1e3];case 2:throw a=o.sent(),t.auth.setAccessTokenExpiresAt(new Date(0)),t.auth.setAccessToken(""),a;case 3:return[2]}})})()},n.startAuth=function(){var t=this;return(0,r._)(function(){var e;return(0,i.YH)(this,function(n){switch(n.label){case 0:return[4,t.auth.getAuthenticationUrl(j,void 0,"code","offline",void 0,void 0,!0)];case 1:return e=n.sent(),window.sessionStorage.setItem("dropboxCodeVerifier",t.auth.getCodeVerifier()),window.location.replace(e),[2]}})})()},n.codeAuth=function(t){var e=this;return(0,r._)(function(){var n,r,a,o,s,u;return(0,i.YH)(this,function(i){switch(i.label){case 0:if(!(n=window.sessionStorage.getItem("dropboxCodeVerifier")))throw Error("no codeVerifier");return e.auth.setCodeVerifier(n),window.sessionStorage.removeItem("dropboxCodeVerifier"),[4,e.auth.getAccessTokenFromCode(j,t)];case 1:return a=(r=i.sent().result).refresh_token,o=r.access_token,s=r.expires_in,u=new Date().getTime()+1e3*s,e.auth.setAccessToken(o),e.auth.setAccessTokenExpiresAt(new Date(u)),e.emit("loginDataUpdate",{refreshToken:a,accessToken:o,expiresAt:u}),[2]}})})()},n.getRemoteContents=function(t){var e=this;return(0,r._)(function(){var n,a,o,s,u,c,l;return(0,i.YH)(this,function(h){switch(h.label){case 0:return n=["images","frames"],a="diff"===t,[4,e.checkLoginStatus()];case 1:if(!h.sent())throw Error("not logged in");h.label=2;case 2:return h.trys.push([2,5,,6]),[4,e.addToQueue("dbx.filesDownload /settings.json",e.throttle,function(){return e.dbx.filesDownload({path:e.toPath("/settings/settings.json")})},a)];case 3:return s=h.sent().result,[4,(0,E.A)(s.fileBlob,E.Z.TEXT)];case 4:return o=JSON.parse(h.sent()),[3,6];case 5:return h.sent(),o={state:{lastUpdateUTC:0,version:m.A}},[3,6];case 6:var f;return[4,Promise.all(n.map((f=(0,r._)(function(t){var n,r,o,s,u;return(0,i.YH)(this,function(i){switch(i.label){case 0:o="",i.label=1;case 1:return i.trys.push([1,3,,4]),[4,e.addToQueue("dbx.filesListFolder /".concat(t),e.throttle,function(){return e.dbx.filesListFolder({path:e.toPath("/settings/".concat(t)),limit:250,recursive:!0})},a)];case 2:return n=(s=i.sent()).result.entries,r=s.result.has_more,o=s.result.cursor,[3,4];case 3:return i.sent(),n=[],r=!1,[3,4];case 4:if(!r)return[3,6];return u=n.concat,[4,e.getMoreContents(o,a)];case 5:n=u.apply(n,[i.sent()]),i.label=6;case 6:return[2,n.filter(function(t){return"file"===t[".tag"]})]}})}),function(t){return f.apply(this,arguments)})))];case 7:return c=(u=D._.apply(void 0,[h.sent(),2]))[0],l=u[1],[2,{images:e.augmentFileList("images",c,a),frames:e.augmentFileList("frames",l,a),settings:o}]}})})()},n.getImageContents=function(){var t=this;return(0,r._)(function(){var e,n,r,a,o;return(0,i.YH)(this,function(i){switch(i.label){case 0:r="",i.label=1;case 1:return i.trys.push([1,3,,4]),[4,t.addToQueue("dbx.filesListFolder /images",t.throttle,function(){return t.dbx.filesListFolder({path:t.toPath("/images"),limit:250,recursive:!0})})];case 2:return e=(a=i.sent()).result.entries,n=a.result.has_more,r=a.result.cursor,[3,4];case 3:return i.sent(),e=[],n=!1,[3,4];case 4:if(!n)return[3,6];return o=e.concat,[4,t.getMoreContents(r)];case 5:e=o.apply(e,[i.sent()]),i.label=6;case 6:return[2,e.reduce(function(t,e){return"file"===e[".tag"]?(0,s._)(t).concat([e]):t},[])]}})})()},n.getMoreContents=function(t,e){var n=this;return(0,r._)(function(){var r,a,o,s,u;return(0,i.YH)(this,function(i){switch(i.label){case 0:o="",i.label=1;case 1:return i.trys.push([1,3,,4]),[4,n.addToQueue("dbx.filesListFolderContinue ".concat(t),n.throttle,function(){return n.dbx.filesListFolderContinue({cursor:t})},e)];case 2:return r=(s=i.sent()).result.entries,a=s.result.has_more,o=s.result.cursor,[3,4];case 3:return i.sent(),r=[],a=!1,[3,4];case 4:if(!a)return[3,6];return u=r.concat,[4,n.getMoreContents(o,e)];case 5:r=u.apply(r,[i.sent()]),i.label=6;case 6:return[2,r]}})})()},n.augmentFileList=function(t,e,n){var r=this;return e.map(function(a,o){var s,i=a.path_lower,u=a.content_hash,c=a.name,l=i?r.inSettingsPath(i):"";switch(t){case"images":case"frames":s=c.split(".")[0];break;default:s="-"}return{path:l,name:c,contentHash:u||"",hash:s,getFileContent:function(){return r.getFileContent(l,o,e.length,n)}}})},n.getFileContent=function(t,e,n){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=this;return(0,r._)(function(){var r,s;return(0,i.YH)(this,function(i){switch(i.label){case 0:return r="dbx.filesDownload (".concat(e+1,"/").concat(n,") ").concat(t),[4,o.addToQueue(r,o.throttle,function(){return o.dbx.filesDownload({path:o.toPath("/settings/".concat(t))})},a)];case 1:return s=i.sent().result,[2,(0,E.A)(s.fileBlob,E.Z.TEXT)]}})})()},n.upload=function(t,e){var n=this;return(0,r._)(function(){var a,o,s,u,c,l;return(0,i.YH)(this,function(h){var f,p;switch(h.label){case 0:return a=t.upload,o=t.del,[4,Promise.all(a.map((f=(0,r._)(function(t,r){return(0,i.YH)(this,function(o){switch(o.label){case 0:return[4,n.addToQueue("dbx.filesUpload (".concat(r+1,"/").concat(a.length,") ").concat(t.destination),n.throttle,function(){return n.dbx.filesUpload({path:n.toPath("/".concat(e,"/").concat(t.destination)),contents:t.blob,mode:{".tag":"overwrite"}})})];case 1:return[2,o.sent().result]}})}),function(t,e){return f.apply(this,arguments)})))];case 1:if(s=h.sent(),!o.length)return[2,{uploaded:s,deleted:[]}];return[4,n.addToQueue("dbx.filesDeleteBatch ".concat(o.length," files"),n.throttle,function(){return n.dbx.filesDeleteBatch({entries:o.map(function(t){var e=t.path;return{path:n.toPath("/settings/".concat(e))}})})})];case 2:return u=h.sent().result.async_job_id,p=(0,r._)(function(){var t,e,r;return(0,i.YH)(this,function(a){switch(a.label){case 0:return[4,n.addToQueue("dbx.filesDeleteBatchCheck ".concat(u),2e3,function(){return n.dbx.filesDeleteBatchCheck({async_job_id:u})})];case 1:if(e=(t=a.sent().result)[".tag"],r=t.entries,"in_progress"===e)return[2,c()];return[2,r.map(function(t){return t.metadata})]}})}),[4,(c=function(){return p.apply(this,arguments)})()];case 3:return l=h.sent(),[2,{uploaded:s,deleted:l}]}})})()},n.startLongPollSettings=function(){var t=this;console.info("Start dropbox longpolling"),this.dbx.filesListFolderGetLatestCursor({path:this.toPath("/settings"),recursive:!1,include_media_info:!1,include_deleted:!1,include_has_explicit_shared_members:!1}).then(function(e){var n=e.result.cursor,r=function(){return t.dbx.filesListFolderLongpoll({cursor:n,timeout:480})};return r().then(function(e){var n=e.result.changes;return(console.info("Longpoll info. Changes: ",n),n)?(t.emit("settingsChanged"),t.addToQueue("Restart longpolling",t.throttle,function(){return t.startLongPollSettings(),Promise.resolve(null)},!0)):r()})}).catch(function(t){g.A.getState().setError(t)})},e}(U.EventEmitter),N=n(3899),I=n.n(N);function K(){return(K=(0,r._)(function(t){var e,n,a;return(0,i.YH)(this,function(o){switch(o.label){case 0:var u;return[4,Promise.all(I()(new Uint8Array(t),4194304).map((u=(0,r._)(function(t){var e;return(0,i.YH)(this,function(n){switch(n.label){case 0:return e=Uint8Array.bind,[4,crypto.subtle.digest("SHA-256",new Uint8Array(t))];case 1:return[2,s._.apply(void 0,[new(e.apply(Uint8Array,[void 0,n.sent()]))])]}})}),function(t){return u.apply(this,arguments)})))];case 1:return e=new Uint8Array(o.sent().flat()),a=Uint8Array.bind,[4,crypto.subtle.digest("SHA-256",e)];case 2:return n=new(a.apply(Uint8Array,[void 0,o.sent()])),[2,(0,s._)(n).map(function(t){return t.toString(16).padStart(2,"0")}).join("")]}})})).apply(this,arguments)}var O=[],q=function(t,e){var n,u,l,Y,P=g.A.getState(),R=P.setSyncBusy,D=P.setSyncSelect,U=v.A.getState(),B=U.setProgressLog,F=U.resetProgressLog,E=p.A.getState(),j=E.dismissDialog,N=E.setDialog,I=new(h())(1,1/0),q=function(t){return function(e,n,a,o){return I.add((0,r._)(function(){return(0,i.YH)(this,function(r){switch(r.label){case 0:return[4,(0,y.c)(n)];case 1:return r.sent(),o||B("dropbox",{timestamp:new Date().getTime()/1e3,message:"".concat(t," runs ").concat(e)}),[2,a()]}})}))}},Z=new Q(w.A.getState().dropboxStorage,q("Dropbox")),M=(n=(0,r._)(function(t){return(0,i.YH)(this,function(e){switch(e.label){case 0:return[4,Z.setRootPath(t.path||"/")];case 1:return e.sent(),[2]}})}),function(t){return n.apply(this,arguments)}),V=(u=(0,r._)(function(t){var n,a,o,s,u,l,h,p,d,g,m,v;return(0,i.YH)(this,function(y){switch(y.label){case 0:return R(!0),D(!1),n=b.A.getState().preferredLocale,a=w.A.getState().syncLastUpdate,[4,Z.getRemoteContents(t)];case 1:switch(o=y.sent(),t){case"diff":return[3,2];case"up":return[3,3];case"down":return[3,6]}return[3,8];case 2:if((null==o||null==(u=o.settings)||null==(s=u.state)?void 0:s.lastUpdateUTC)===null)return[3,9];return h=(null==(l=o.settings.state)?void 0:l.lastUpdateUTC)===void 0?Date.now()/1e3:o.settings.state.lastUpdateUTC,w.A.getState().setSyncLastUpdate("dropbox",h),h>(null==a?void 0:a.local)&&N({message:"There is newer content in your dropbox!",questions:function(){return["Your dropbox contains changes from ".concat((0,_.A)(c()(1e3*h),n)),"Your last local update was ".concat((null==a?void 0:a.local)?(0,_.A)(c()(1e3*a.local),n):"never","."),"Do you want to load the changes?"].map(function(t,e){return{label:t,key:"info".concat(e),type:f.V.INFO}})},confirm:(0,r._)(function(){return(0,i.YH)(this,function(t){return j(0),V("down"),[2]})}),deny:(0,r._)(function(){return(0,i.YH)(this,function(t){return[2,j(0)]})})}),[3,9];case 3:return p=(null==a?void 0:a.local)||Math.floor(new Date().getTime()/1e3),[4,(0,S.A)(o,p,q("GBPrinter"))];case 4:return d=y.sent(),[4,Z.upload(d,"settings")];case 5:return y.sent(),w.A.getState().setSyncLastUpdate("dropbox",p),[3,9];case 6:return[4,(0,L.Ay)(o)];case 7:return e(y.sent()),(v=(null==(m=o.settings)||null==(g=m.state)?void 0:g.lastUpdateUTC)||0)&&w.A.getState().setSyncLastUpdate("dropbox",v),[3,9];case 8:throw Error("dropbox sync: wrong sync case");case 9:return"diff"!==t?B("dropbox",{timestamp:new Date().getTime()/1e3,message:"."}):F(),R(!1),[2]}})}),function(t){return u.apply(this,arguments)}),G=(l=(0,r._)(function(){var t,e,n,u,c,l,h,f,p,g,v,w,_,y,S,x,L;return(0,i.YH)(this,function(Y){var P,U;switch(Y.label){case 0:return R(!0),D(!1),e=(t=m.h.getState()).frames,n=t.palettes,u=t.images,l=(c=b.A.getState()).exportScaleFactors,h=c.exportFileTypes,f=c.handleExportFrame,p=c.fileNameStyle,g=d.A.getState(),v=(0,T.S)(u,g),w=(0,A.j)(l,h,f,n,p),_=(0,H.T)(u,e),[4,Promise.all(v.map((P=(0,r._)(function(t,n){return(0,i.YH)(this,function(a){return[2,q("Generate images and hashes")("".concat(n+1,"/").concat(v.length),10,(0,r._)(function(){var n,a,o,s,u;return(0,i.YH)(this,function(c){switch(c.label){case 0:return[4,_(t.hash)];case 1:if(n=c.sent(),!(a=e.find(function(e){return e.id===t.frame})))return[3,3];return[4,(0,k.mZ)(null==a?void 0:a.hash)];case 2:return s=c.sent(),[3,4];case 3:s=null,c.label=4;case 4:if(u=(o=s)?o.upper.length/20:2,!n)throw Error("tiles missing");return[4,w(t)(n,u)];case 5:var l;return[4,Promise.all(c.sent().map((l=(0,r._)(function(t){var e;return(0,i.YH)(this,function(n){switch(n.label){case 0:return e={filename:t.filename},[4,t.blob.arrayBuffer()];case 1:return[2,(e.arrayBuffer=n.sent(),e)]}})}),function(t){return l.apply(this,arguments)})))];case 6:return[2,c.sent()]}})}))]})}),function(t,e){return P.apply(this,arguments)})))];case 1:return y=Y.sent().flat(),[4,Promise.all((0,C.A)(y).map((U=(0,r._)(function(t){var e,n;return(0,i.YH)(this,function(r){switch(r.label){case 0:return e=[(0,a._)({},t)],n={},[4,function(t){return K.apply(this,arguments)}(t.arrayBuffer)];case 1:return[2,o._.apply(void 0,e.concat([(n.dropboxContentHash=r.sent(),n)]))]}})}),function(t){return U.apply(this,arguments)})))];case 2:return S=Y.sent(),[4,Z.getImageContents()];case 3:return x=Y.sent(),L=S.reduce(function(t,e){var n=e.arrayBuffer,r=e.dropboxContentHash,a=e.filename;return -1===x.findIndex(function(t){var e=t.content_hash,n=t.name;return e===r&&n===a})?(0,s._)(t).concat([{blob:new Blob([n]),destination:a}]):t},[]),[4,Z.upload({upload:L,del:[]},"images")];case 4:return Y.sent(),B("dropbox",{timestamp:new Date().getTime()/1e3,message:"."}),R(!1),[2]}})}),function(){return l.apply(this,arguments)}),J=(Y=(0,r._)(function(e){var n,r;return(0,i.YH)(this,function(a){switch(a.label){case 0:if(n=t.updateImages,O.includes(e))return[3,3];return O.push(e),[4,Z.getFileContent("images/".concat(e,".txt"),0,1,!0)];case 1:return r=a.sent(),[4,(0,L._K)(r)];case 2:a.sent(),n([]),a.label=3;case 3:return[2]}})}),function(t){return Y.apply(this,arguments)}),X=function(){V("diff")};w.A.getState().dropboxStorage.autoDropboxSync&&(X(),Z.on("settingsChanged",function(){X()})),Z.on("loginDataUpdate",function(t){(0,w.A.getState().setDropboxStorage)(t)});var z=x().dropboxCode;return z&&Z.codeAuth(z),w.A.subscribe(function(t){return t.dropboxStorage},M),{updateSettings:M,startSyncData:V,startSyncImages:G,startAuth:function(){return Z.startAuth()},recoverImageData:J}}},99451:(t,e,n)=>{n.d(e,{N:()=>a});var r=n(577),a=function(t,e){return e?(0,r._)(t).concat([e]):t}}}]);